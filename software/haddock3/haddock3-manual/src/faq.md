## Frequently Asked Questions

We collect here frequently occurring problems and solutions. The following topics are currently available:

- [What about missing atoms or chain breaks?](#what-about-missing-atoms-or-chain-breaks)
- [What about point mutations?](#what-about-point-mutations)
- [What about ions?](#what-about-ions)
- [Domain definition for docking](#domain-definition-for-docking)
- [Clustering issues](#clustering-issues)
- [Running HADDOCK on a cluster using a queuing system (e.g. Torque or Slurm)](#running-haddock-on-a-cluster-using-a-queuing-system-eg-torque-or-slurm)
- [Small ligand docking with HADDOCK](#small-ligand-docking-with-haddock)
- [Usage of dummy atoms / beads with HADDOCK](#beads-dummy-atoms-docking-with-haddock)

<hr>

### What about missing atoms? 

Missing atoms will be automatically detected (if part of the [HADDOCK library](https://wenmr.science.uu.nl/haddock2.4/library)) and re-generated when running the [`[topoaa]` module](./modules/topology.md#topoaa-module).
For this reason, it is always used as first modules in a haddock3 workflow configuration file, not only to generate the topology of the input molecules but also to add and reconstruct missing atoms.

<hr>

### What about chain breaks?

In case of missing residues, chain breaks will be introduced.
This might cause segments of your molecule to move with respect to each other during the refinement stages.
To avoid that, you can define a few specific distance restraints, for example between CA atom.
This can be easily performed by the `haddock3-restraints` command line interface supporting the `restrain_bodies` subcommand that allows to detect such breaks and define distance restraints.
Here is the documentation to the [`haddock3-restraints restrain_bodies` subcommand](./restraints_cli.md#restrain-bodies).
Those restraints can then be provided to haddock3 as unambiguous restraints for example (using the `unambig_fname` parameter in CNS modules).

<hr>

### What about point mutations?  

To introduce mutations in your input PDB files you can do the following:

*  edit the PDB file and rename the mutated residue to the proper amino acid name
*  keep or rename appropriately the matching side-chain atoms

The extra/missing atoms will be automatically detected and the corrected topology and coordinates will be regenerated by the [`[topoaa]` module](./modules/topology.md#topoaa-module).
It is important to have at least the backbone atoms and at least the CB atom along the side-chain defined since their average position will be used as starting point to "grow" the missing atoms.
Always check that the sequence of the various PDB files match!

**Note** that this approach is only functional for residues supported in the [HADDOCK library](https://wenmr.science.uu.nl/haddock2.4/library).


<hr>

### What about ions?

Some proteins contains ions such as for example calcium.
Their inclusion might be important for docking purposes, in particular for proper electrostatics!
In principle, they should be recognized when running the [`[topoaa]` module](./modules/topology.md#topoaa-module), provided their name in the PDB file matches the ion names in the list of supported ions (can be found [here](https://wenmr.science.uu.nl/haddock2.4/library)).


<hr>

### Domain definition for docking  

In general, it is recommended to remove any part of your system such as flexible linkers that are not involved in the interaction with the partner for docking.
Keeping these might give trouble in the sorting of solutions.
For example, such a linker can make contacts with the partner molecule, resulting in a lower total energy and, in that way, "bad" solutions could still be kept.

The same applies for AlphaFold2 *spaghetti* like disordered regions that often surround the domain of interest.
Indeed, these regions may induce van der Walls forces due to sterical clashes before the two domain of interest could even interact.
Removing regions with low pLDDT (~< 60) can be an appropriate solution so use AlphaFold2 models for docking.


<hr>

### Clustering issues  


When perfoming RMSD clustering, two modules can be used to compute the RMSD matrix:
- `[rmsdmatrix]`: computing the full complex (or single chain) RMSD matrix
- `[ilrmsdmatrix]`: computing the interface-ligand RMSD matrix

The `[rmsdmatrix]` module allows you to define a subset of resiudes used to perform both the structural alignment and the RMSD computation.
For this, you need to specify a list of residue for each chain, using the parameter `resdic_*`, where `*` is the chainID.
As an example, to perform the selection of residues 12, 13, 14 and 15 from chain A and 1, 2, 3 from chain B, refine the following parameters:
```toml
[rmsdmatrix]
resdic_A = [12, 13, 14, 15]
resdic_B = [1, 2, 3]
```
This will result in the selectio of those 7 residues to perform the structural alignment onto the reference and then compute the RMSD.

While for the `[ilrmsdmatrix]` module, a different approach is taken.
Two parameters must be defined
- `receptor_chain`: defining the chainID of the receptor. By default "A".
- `ligand_chains`: a list of other chain IDs that should represent the "ligands". If not set, all the remaining chains will be considered as ligand.

During the computational workflow, first all the residue-residue contacts between the receptor and ligand are selected.
This selection is then used to perform later structural alignment and RMSD computation.

Those two modules must be followed by the `[clustrmsd]` module, otherwise only the pair-wise RMSD matrix will be computed, and clustering not performed.
**Note** that this is not an issue if fractions of common contact (FCC) clustering  ([`clustfcc`] module) is used as the matrix is computed within the clustering module directly (*as much faster*).


<hr>

### Running HADDOCK on a cluster using a queuing system (e.g. Torque or Slurm)  

In order to submit to the queuing system we typically use a wrapper script that will add some directives to the job files.

First, we must define a haddock3 workflow (e.g.: `haddock_run.cfg`):

```toml
#################################
# GLOBAL PARAMETERS
#################################
run_dir = "amazing_docking_experiment"
molecules ["protein1.pdb", "protein2.pdb"]
# Here we define the maximum number of available cores to use
ncores = 40

#################################
# WORKFLOW MODULES PARAMETERS
#################################
[topoaa]
[rigidbody]
[seletop]
[flexref]
[emref]
[clustfcc]
[seletopclusts]
[contactmap]
[caprieval]
```

Here is one example of such a wrapper script (named `haddock3_run.job`) that would submit to the slurm queue:

```bash
#!/bin/bash
#SBATCH --nodes=1
#SBATCH --tasks-per-node=40
#SBATCH -J haddock3-run
#SBATCH -p short

# 1. Active the haddock3 virtual environement
# From venv
source /path/to/haddock3/intall/dir/.haddock3-env/bin/activate
# Or using conda
source /path/to/conda/intall/dir/bin/activate
conda activate haddock3-env

# Go to the base directory where the `haddock_run.cfg` workflow is written
cd /path/to/workflow/

# Execute haddock3 on the `haddock_run.cfg` workflow
haddock3 haddock_run.cfg
```

**Note** here that we set up the number of cores for both the *haddock3* run (in `haddock_run.cfg`) and *slurm* job (in `haddock3_run.job`)to **40**


<hr>

### Cofactors / Small-ligand docking with HADDOCK  

It's possible to dock small-ligands or cofactor using haddock3, but for that topology and parameter files for the ligand should be provided in CNS format.

Several sources exist to find such files:

* **ccp4-prodrg**: [`ccp4-prodrg`](https://www.ccp4.ac.uk/html/index.html).
* the **PRODRG** server was maintained by Daan van Aalten at Dundee University: [https://prodrg2.dyndns.org](https://prodrg2.dyndns.org).
  This server allowed you to draw your molecule or paste coordinates and will return topologies and parameter files in various format, including CNS.
  You should turn on the electrostatic to obtain partial charges. Save the resulting PDB file and the corresponding CNS parameter and topology files to use in HADDOCK.  

  **Important:** The generated parameter file contains a CNS NBONds statement which should be removed prior to use in HADDOCK. Look in the parameter file for:  

  <pre style="background-color:#DAE4E7">     NBONds
         CUTNB=7.0 WMIN=1.5
         REPEL=1.0 REXPONENT=4
         IREXPONENT=1 RCONST=16.0
         TOLERANCE=0.5 NBXMOD=5
         CTONNB=5.5 CTOFNB=6.0
       END
  </pre>

  and remove or comment it out (by adding ! before each line).  

* the Automated Topology Builder (ATB) and Repository developed in Prof. Alan Mark's group at the University of Queensland in Brisbane: [https://atb.uq.edu.au/](https://atb.uq.edu.au/)  
  **Note**: we did not yet test those parameters in HADDOCK.


For docking small ligand with haddock3 using custom-made topology and parameter files, you should:

- Define the path to the files in CNS modules (`[topoaa]`, `[flexref]`, `[emref]`, `[mdref]`, `[emscoring]`, `[mdscoring]`)
  - Input the topology file using `ligand_top_fname` parameter.
  - Input the parameter file using `ligand_param_fname` parameter.

Also we recommend to set the number of MD steps for the first two parts (rigid-body high temperature dynamic and slow cooling annealing) of the [`[flexref] module`](./modules/refinement.md#flexref-module) to 0.  
This is performed by tuning the `mdsteps_rigid` and `mdsteps_cool1` parameters and setting their values to 0.

Haddock3 comes with an [example for protein-ligand docking](./docking_scenarios/prot-ligand.md). Check the setting in that example.

**Important:** When starting a run, always check for error messages in the `0_topoaa` directory in the various generated `.out` files, especially for your ligand.

<hr>
